# –ú—å—é—Ç–µ–∫—Å

–û—Ç–ª–∏—á–∏–µ _–º—å—é—Ç–µ–∫—Å–∞_ –æ—Ç _—Å–ø–∏–Ω–ª–æ–∫–∞_ –ø—Ä–æ—è–≤–ª—è–µ—Ç—Å—è –≤ —Å–∏—Ç—É–∞—Ü–∏–∏ _contention_, –∫–æ–≥–¥–∞ —Å—Ä–∞–∑—É –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ—Ç–æ–∫–æ–≤ –∫–æ–Ω–∫—É—Ä–∏—Ä—É—é—Ç –∑–∞ –≤–ª–∞–¥–µ–Ω–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π: 

- –í _–º—å—é—Ç–µ–∫—Å–µ_ –∂–¥—É—â–∏–π –ø–æ—Ç–æ–∫ _–±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è_ (_blocking_) –≤ —Å–∏—Å—Ç–µ–º–Ω–æ–π –æ—á–µ—Ä–µ–¥–∏ –æ–∂–∏–¥–∞–Ω–∏—è, —É—Ö–æ–¥–∏—Ç —Å —è–¥—Ä–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞,
- –í _—Å–ø–∏–Ω–ª–æ–∫–µ_ –∂–¥—É—â–∏–π –ø–æ—Ç–æ–∫ _–∫—Ä—É–∂–∏—Ç—Å—è_ (_spinning_) –Ω–∞ —è–¥—Ä–µ.

## –ó–∞–¥–∞–Ω–∏–µ

–ù–∞–ø–∏—à–∏—Ç–µ [std::mutex](https://ru.cppreference.com/w/cpp/thread/mutex).

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –ï—Å–ª–∏ –ø–æ—Ç–æ–∫ –Ω–µ –º–æ–∂–µ—Ç –∑–∞—Ö–≤–∞—Ç–∏—Ç—å –º—å—é—Ç–µ–∫—Å, –ø–æ—Ç–æ–º—É —á—Ç–æ –µ–≥–æ –æ–ø–µ—Ä–µ–∂–∞—é—Ç –¥—Ä—É–≥–∏–µ –ø–æ—Ç–æ–∫–∏, —Ç–æ –æ–Ω –¥–æ–ª–∂–µ–Ω –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å—Å—è –¥–æ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è –º—å—é—Ç–µ–∫—Å–∞ –∏ –æ—Å–≤–æ–±–æ–¥–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä.
* –ï—Å–ª–∏ –∂–µ contention-–∞ –Ω–µ—Ç, —Ç–æ –∑–∞—Ö–≤–∞—Ç –∏ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –º—å—é—Ç–µ–∫—Å–∞ –¥–æ–ª–∂–Ω—ã –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –±–µ–∑ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤ —è–¥—Ä–æ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã.


## Futex

–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ä–µ–∞–ª–∏–∑—É–µ—Ç—Å—è –≤ —è–¥—Ä–µ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã, –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å / –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Ç–æ–∫ –º–æ–∂–µ—Ç —Ç–æ–ª—å–∫–æ _–ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫_ –û–°.

–î–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ (—Ç–æ—á–Ω–µ–µ, _Linux_) –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º ‚Äì _futex_.

Futex ‚Äì —è–¥–µ—Ä–Ω–∞—è –æ—á–µ—Ä–µ–¥—å —Å–ø—è—â–∏—Ö –ø–æ—Ç–æ–∫–æ–≤, –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫ —è—á–µ–π–∫–µ –ø–∞–º—è—Ç–∏ –≤ –∞–¥—Ä–µ—Å–Ω–æ–º –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–±–æ—Ç–∞–µ—Ç —Å —Ñ—å—é—Ç–µ–∫—Å–æ–º —á–µ—Ä–µ–∑ –æ–¥–Ω–æ–∏–º–µ–Ω–Ω—ã–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –≤—ã–∑–æ–≤ ‚Äì [futex(2)](http://man7.org/linux/man-pages/man2/futex.2.html).

–û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ: `futex` —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å 32-–±–∏—Ç–Ω—ã–º–∏ —è—á–µ–π–∫–∞–º–∏ –ø–∞–º—è—Ç–∏.

### References

- [futex(2)](http://man7.org/linux/man-pages/man2/futex.2.html)
- [kernel/futex/waitwake.c](https://github.com/torvalds/linux/blob/master/kernel/futex/waitwake.c)

### –ì–∞—Ä–∞–Ω—Ç–∏–∏

–ö–æ–Ω–∫—É—Ä–∏—Ä—É—é—â–∏–µ –≤—ã–∑–æ–≤—ã —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞ `futex` –±—É–¥—É—Ç –∞—Ç–æ–º–∞—Ä–Ω—ã –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –¥—Ä—É–≥ –¥—Ä—É–≥–∞: –≤ —è–¥—Ä–µ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –æ—á–µ—Ä–µ–¥—å—é —Ñ—å—é—Ç–µ–∫—Å–∞ –±–µ—Ä–µ—Ç—Å—è —Å–ø–∏–Ω–ª–æ–∫.

–ü—Ä–∏ —ç—Ç–æ–º –≤—ã–∑–æ–≤ `futex` –≤ —Ä–µ–∂–∏–º–µ –æ–∂–∏–¥–∞–Ω–∏—è –Ω–µ –±—É–¥–µ—Ç –∞—Ç–æ–º–∞—Ä–Ω—ã–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–ø–∏—Å–µ–π –≤ —è—á–µ–π–∫—É –ø–∞–º—è—Ç–∏: –∑–∞–ø–∏—Å—å –º–æ–∂–µ—Ç –≤—ã–ø–æ–ª–Ω–∏—Ç—å—Å—è –º–µ–∂–¥—É —á—Ç–µ–Ω–∏–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –∏ –ø–∞—Ä–∫–æ–≤–∫–æ–π –ø–æ—Ç–æ–∫–∞ –≤ —Å–∏—Å—Ç–µ–º–Ω–æ–º –≤—ã–∑–æ–≤–µ.

–ü—Ä–æ—á—Ç–∏—Ç–µ [Basic futex operation and ordering guarantees](https://github.com/torvalds/linux/blob/master/kernel/futex/waitwake.c) –∏–∑ —è–¥—Ä–∞ _Linux_, —ç—Ç–æ **–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π** –Ω–∞–¥–µ–∂–Ω—ã–π —Å–ø–æ—Å–æ–± —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è –≤ –≥–∞—Ä–∞–Ω—Ç–∏—è—Ö `futex`.


## `twist::ed::futex::Wait`

–ú—ã –±—É–¥–µ–º —Ä–∞–±–æ—Ç–∞—Ç—å —Å —Å–∏—Å—Ç–µ–º–Ω—ã–º –º–µ—Ö–∞–Ω–∏–∑–º–æ–º –æ–∂–∏–¥–∞–Ω–∏—è –Ω–µ –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –≤—ã–∑–æ–≤—ã, –∞ —á–µ—Ä–µ–∑ API `twist/ed/wait/futex.hpp`:

- [API](https://gitlab.com/Lipovsky/twist/-/blob/master/docs/ru/guide.md#futexwait)
- [–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è](https://gitlab.com/Lipovsky/twist/-/blob/master/examples/wait/main.cpp)

üöß –î–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –≤ —à–∞–±–ª–æ–Ω–∞—Ö –∑–∞–¥–∞—á –ø–æ-–ø—Ä–µ–∂–Ω–µ–º—É –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∑–∞–≥–æ–ª–æ–≤–æ–∫ `twist/ed/wait/sys.hpp`. 

### –û—Ç–ª–∏—á–∏—è –æ—Ç —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞ `futex`

`futex::Wait` –æ–±–æ—Ä–∞—á–∏–≤–∞–µ—Ç –≤—ã–∑–æ–≤ `futex` –≤ —Ü–∏–∫–ª —Å –ø–µ—Ä–µ–ø—Ä–æ–≤–µ—Ä–∫–æ–π —É—Å–ª–æ–≤–∏—è:

```cpp
void Wait(stdlike::atomic<uint32_t>& atom, uint32_t old) {
  while (atom.load() == old) {
    SystemWait(Addr(atom), old);
  }
}
```

`Wake` –¥–≤—É—Ö—Ñ–∞–∑–Ω—ã–π: 

1) –°–Ω–∞—á–∞–ª–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ _–¥–æ_ –∑–∞–ø–∏—Å–∏ –≤ –∞—Ç–æ–º–∏–∫, –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–µ–¥—à–µ—Å—Ç–≤—É–µ—Ç –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏—é) —Å –ø–æ–º–æ—â—å—é `PrepareWake` —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è –∫–ª—é—á –¥–ª—è –∞–¥—Ä–µ—Å–∞—Ü–∏–∏ —Å–∏—Å—Ç–µ–º–Ω–æ–π –æ—á–µ—Ä–µ–¥–∏ –æ–∂–∏–¥–∞–Ω–∏—è (—Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏ ‚Äì –∞–¥—Ä–µ—Å —è—á–µ–π–∫–∏ –ø–∞–º—è—Ç–∏) –¥–ª—è –∞—Ç–æ–º–∏–∫–∞:

```cpp
WakeKey PrepareWake(stdlike::atomic<uint32_t>& atom) {
  return {Addr(atom)};
}
````

2) –ó–∞—Ç–µ–º (_–ø–æ—Å–ª–µ_ –∑–∞–ø–∏—Å–∏ –≤ –∞—Ç–æ–º–∏–∫) –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `futex` —Å –∞–¥—Ä–µ—Å–æ–º, –∫–æ—Ç–æ—Ä—ã–π –±—ã–ª –≤–∑—è—Ç –Ω–∞ –ø–µ—Ä–≤–æ–º —à–∞–≥–µ:

```cpp
void WakeOne(WakeKey key) {
  SystemWake(key.addr, 1);
}
```

–í —ç—Ç–∏—Ö —Å–Ω–∏–ø–ø–µ—Ç–∞—Ö `SystemWait` –∏ `SystemWake` ‚Äì —ç—Ç–æ —É—Å–ª–æ–≤–Ω—ã–µ –æ–±–æ–∑–Ω–∞—á–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞ `futex` –≤ —Ä–µ–∂–∏–º–∞—Ö –æ–∂–∏–¥–∞–Ω–∏—è –∏ –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏—è.

### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

–§—å—é—Ç–µ–∫—Å —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å 32-–±–∏—Ç–Ω—ã–º–∏ —Å–ª–æ–≤–∞–º–∏ –≤ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —Ç–∞–∫ —á—Ç–æ `Wait` –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ `atomic<uint32_t>`.
