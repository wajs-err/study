# Считающий семафор

Семафор – это автомат с жетонами, который поддерживает две операции:

- `Acquire()` – Взять один жетон из автомата. Если автомат пуст, то заблокироваться до появления в нем жетонов.
- `Release()` – Положить (вернуть) в автомат один жетон.
 
Начальное число жетонов в семафоре задается в конструкторе.

Поток, забравший жетон из семафора, получает право доступа к некоторому ограниченному пулу ресурсов.

Будем считать, что в семафор помещается неограниченное количество жетонов.

Семафор никакие жетоны явно не хранит, а просто поддерживает счетчик.

Другая интерпретация:

Семафор – это атомарный счетчик с операциями инкремента и декремента. При попытке декрементировать нулевой счетчик поток блокируется до тех пор, пока другой поток не поднимет значение счетчика выше нуля.

## Семафоры в `std`

См. [std::counting_semaphore](https://en.cppreference.com/w/cpp/thread/counting_semaphore)

## Очередь

На семафоры можно смотреть как на базовый примитив синхронизации, альтернативу сразу и мьютексам, и кондварам:

- [Semaphores are Surprisingly Versatile](https://preshing.com/20150316/semaphores-are-surprisingly-versatile/)
- [Little book of semaphores](http://greenteapress.com/semaphores/LittleBookOfSemaphores.pdf)

Чтобы убедиться в этом, реализуйте очередь для передачи данных между потоками используя для синхронизации исключительно семафоры.

## Задание

1) Реализуйте [считающий семафор](semaphore.hpp) с помощью условных переменных.

2) С помощью семафоров реализуйте [блокирующую очередь](queue.hpp) для передачи данных между потоками.

## `TaggedSemaphore`

Клаcc `Semaphore` позволяет использовать себя неправильно:  

- Пользователь может позвать `Release` на семафоре даже если перед этим не получил от него жетон через `Acquire`, т.е. может генерировать жетоны из воздуха.
- Можно перекладывать жетоны между разными семафорами, что не всегда имеет смысл.

Обе эти проблемы решает [`TaggedSemaphore`](tagged_semaphore.hpp):

- Теперь жетон имеет явное представление – `Token`. Получить жетон можно только из вызова `Acquire`. Копировать жетон нельзя, можно только перемещать.
  
- Сам семафор параметризуется типом `Tag`. Если пользователь перекладывает жетон между семафорами, то должен пометить эти семафоры общим тегом, в противном случае код не скомпилируется.

В реализации очереди возникает потребность перемещать жетоны между семафорами, так что для них стоит завести общий тэг.

## `BoundedBlockingQueue`

При реализации очереди для синхронизации потоков допускается использовать _только_ семафоры и _только_ в виде `TaggedSemaphore`.

Другие примитивы (атомики, мьютексы, кондвары) использовать нельзя.

Писать условную логику (`if`, `while`) в очереди тоже нельзя.
