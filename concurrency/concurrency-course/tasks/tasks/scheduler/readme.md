# Scalable Scheduler

## –ü—Ä–µ—Ä–µ–∫–≤–∏–∑–∏—Ç—ã

- [cond/wait_group](/tasks/cond/wait_group)
- [fibers/mutex](/tasks/fibers/mutex)
- [tasks/executors](/tasks/tasks/executors)
- [lockfree/steal](/tasks/lockfree/steal)
- [fibers/chan](/tasks/fibers/chan) ‚Äì —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è

----

## –ü—Ä–æ–ª–æ–≥

_I suspect that making the scheduler use per-CPU
queues together with some inter-CPU load balancing
logic is probably trivial. Patches already exist, and I
don‚Äôt feel that people can screw up the few hundred lines
too badly._ ‚Äì Linus Torvalds

Credit: [The Linux Scheduler: a Decade of Wasted Cores](https://people.ece.ubc.ca/sasha/papers/eurosys16-final29.pdf)

----

–í —ç—Ç–æ–π –∑–∞–¥–∞—á–µ –≤—ã –¥–æ–ª–∂–Ω—ã —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å [–º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º—ã–π –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫](exe/executors/tp/fast) –¥–ª—è —Ñ–∞–π–±–µ—Ä–æ–≤.

–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ —Å —Ä–æ—Å—Ç–æ–º —á–∏—Å–ª–∞ —è–¥–µ—Ä –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –¥–æ–ª–∂–µ–Ω –≤—ã–ø–æ–ª–Ω—è—Ç—å –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –±–æ–ª—å—à–µ –∑–∞–¥–∞—á –≤ –µ–¥–∏–Ω–∏—Ü—É –≤—Ä–µ–º–µ–Ω–∏.

## –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –¥–ª—è —Ñ–∞–π–±–µ—Ä–æ–≤

–î–æ —ç—Ç–æ–≥–æ –º–æ–º–µ–Ω—Ç–∞ –≤ –∫–∞—á–µ—Å—Ç–≤–µ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ —Ñ–∞–π–±–µ—Ä–æ–≤ –º—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –ø—Ä–æ—Å—Ç–æ–π –ø—É–ª –ø–æ—Ç–æ–∫–æ–≤ —Å —Ä–∞–∑–¥–µ–ª—è–µ–º–æ–π –æ—á–µ—Ä–µ–¥—å—é –∑–∞–¥–∞—á.

–ü—É–ª –ø–æ—Ç–æ–∫–æ–≤ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –≤—ã—á–∏—Å–ª–∏—Ç–µ–ª—å–Ω–æ —Ç—è–∂–µ–ª—ã—Ö –∏ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã—Ö –∑–∞–¥–∞—á. –ù–æ –∑–∞–¥–∞—á–∏ —Ñ–∞–π–±–µ—Ä–æ–≤ —Ç–∞–∫–∏–º–∏ –Ω–µ —è–≤–ª—è—é—Ç—Å—è: –æ–Ω–∏ –∫–æ—Ä–æ—Ç–∫–∏–µ –∏ —á–∞—Å—Ç–æ –∑–∞–≤–∏—Å—è—Ç –¥—Ä—É–≥ –æ—Ç –¥—Ä—É–≥–∞ (—á–µ—Ä–µ–∑ —Ñ–∞–π–±–µ—Ä–Ω—ã–µ –ø—Ä–∏–º–∏—Ç–∏–≤—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏).

### –ë—ã—Å—Ç—Ä—ã–µ –∑–∞–¥–∞—á–∏ –∏ contention –Ω–∞ –æ—á–µ—Ä–µ–¥–∏

–ó–∞–¥–∞—á–∏ –¥–ª—è —Ñ–∞–π–±–µ—Ä–æ–≤ –ø–æ–ª—É—á–∞—é—Ç—Å—è –æ—á–µ–Ω—å –∫–æ—Ä–æ—Ç–∫–∏–º–∏, —Ç–∞–∫ —á—Ç–æ –Ω–∞–∫–ª–∞–¥–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã –Ω–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —ç—Ç–∏—Ö –∑–∞–¥–∞—á —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è —Å–æ–ø–æ—Å—Ç–∞–≤–∏–º—ã —Å –∏—Ö –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ–º.

–ü—Ä–∏ —ç—Ç–æ–º –ø—Ä–æ—Ü–µ–¥—É—Ä–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–¥–∞—á–∏ —É–ø–∏—Ä–∞–µ—Ç—Å—è –≤ –æ–±—â—É—é –æ—á–µ—Ä–µ–¥—å, —Ç.–µ. –≤ –æ–±—â–∏–π –º—å—é—Ç–µ–∫—Å, –∫–æ—Ç–æ—Ä—ã–π –∏ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å: —á–∏—Å–ª–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–µ–∫—Ü–∏–π –≤ –µ–¥–∏–Ω–∏—Ü—É –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –º—å—é—Ç–µ–∫—Å–∞ —Å —Ä–æ—Å—Ç–æ–º —á–∏—Å–ª–∞ —è–¥–µ—Ä –Ω–µ –ø—Ä–æ—Å—Ç–æ –Ω–µ —Ä–∞—Å—Ç–µ—Ç, –∞ –¥–∞–∂–µ —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è.

### –ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è, –ª–æ–∫–∞–ª—å–Ω–æ—Å—Ç—å, –∫—ç—à–∏

–ö—Ä–æ–º–µ —Ç–æ–≥–æ, —Ñ–∞–π–±–µ—Ä—ã –º–æ–≥—É—Ç –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ –∫–æ–º–º—É–Ω–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –º–µ–∂–¥—É —Å–æ–±–æ–π —á–µ—Ä–µ–∑ –ø—Ä–∏–º–∏—Ç–∏–≤—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ (–º—å—é—Ç–µ–∫—Å—ã –∏ –∫–∞–Ω–∞–ª—ã), 
—è–≤–Ω–æ (–≤ —Å–ª—É—á–∞–µ –∫–∞–Ω–∞–ª–æ–≤) –∏–ª–∏ –Ω–µ—è–≤–Ω–æ (–≤ —Å–ª—É—á–∞–µ –º—å—é—Ç–µ–∫—Å–æ–≤) –ø–µ—Ä–µ–¥–∞–≤–∞—è –¥—Ä—É–≥ –¥—Ä—É–≥—É —Å–æ–æ–±—â–µ–Ω–∏—è.

–ï—Å–ª–∏ —Ç–∞–∫–∏–µ –∑–∞–≤–∏—Å–∏–º—ã–µ –∑–∞–¥–∞—á–∏ –∑–∞–ø—É—Å–∫–∞—Ç—å –Ω–∞ –æ–¥–Ω–æ–º —è–¥—Ä–µ –∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ, —Ç–æ –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –≤—ã–∏–≥—Ä—ã—à –∑–∞ —Å—á–µ—Ç —Ç–æ–≥–æ, —á—Ç–æ –ø–æ–ª—É—á–∞—Ç–µ–ª—å 
"—Å–æ–æ–±—â–µ–Ω–∏—è" –ø—Ä–æ—á—Ç–µ—Ç –µ–≥–æ –ø—Ä—è–º–æ –∏–∑ –∫—ç—à–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞, –µ–º—É –Ω–µ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –∏–¥—Ç–∏ –∑–∞ –Ω–∏–º –≤ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω—É—é –ø–∞–º—è—Ç—å.

## –î–∏–∑–∞–π–Ω

–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –∏–¥–µ—è ‚Äì _—à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏–µ_.

### –®–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏–µ

–£ –∫–∞–∂–¥–æ–≥–æ –ø–æ—Ç–æ–∫–∞-–≤–æ—Ä–∫–µ—Ä–∞ –µ—Å—Ç—å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–∞—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–∞—è –æ—á–µ—Ä–µ–¥—å –∑–∞–¥–∞—á (–±—É–¥–µ–º –Ω–∞–∑—ã–≤–∞—Ç—å —ç—Ç—É –æ—á–µ—Ä–µ–¥—å _–ª–æ–∫–∞–ª—å–Ω–æ–π_), –≤–æ—Ä–∫–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å —Å –Ω–µ–π. 

–õ–æ–∫–∞–ª—å–Ω—ã–µ –æ—á–µ—Ä–µ–¥–∏ –ø–æ–∑–≤–æ–ª—è—é—Ç –≤–æ—Ä–∫–µ—Ä–∞–º
- –ò–∑–±–µ–≥–∞—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏–∏ –¥—Ä—É–≥ —Å –¥—Ä—É–≥–æ–º, —á—Ç–æ –ø–æ–≤—ã—à–∞–µ—Ç –ø—Ä–æ–ø—É—Å–∫–Ω—É—é —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞.
- –ö–ª–∞—Å—Ç–µ—Ä–∏–∑–æ–≤–∞—Ç—å –∫–æ–º–º—É–Ω–∏—Ü–∏—Ä—É—é—â–∏–µ –∑–∞–¥–∞—á–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ñ–∞–π–±–µ—Ä—ã) –Ω–∞ –æ–¥–Ω–æ–º —è–¥—Ä–µ, —á—Ç–æ –ø–æ–≤—ã—à–∞–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∫—ç—à–µ–π.

–° –¥—Ä—É–≥–æ–π —Å—Ç–æ—Ä–æ–Ω—ã, —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ª–æ–∂–Ω—è–µ—Ç: 
1) –ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫—É –Ω–∞–≥—Ä—É–∑–∫–∏ –º–µ–∂–¥—É –≤–æ—Ä–∫–µ—Ä–∞–º–∏, —Ç–∞–∫ –∫–∞–∫ –∑–∞–¥–∞—á–∏ –º–æ–≥—É—Ç —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å—Å—è –∏ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–∞ –≤–æ—Ä–∫–µ—Ä–∞—Ö –Ω–µ—Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ. 
2) –ü–∞—Ä–∫–æ–≤–∫—É –≤–æ—Ä–∫–µ—Ä–æ–≤: –±–æ–ª—å—à–µ –Ω–µ–ª—å–∑—è –∞—Ç–æ–º–∞—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—É—Å—Ç–æ—Ç—É –æ–±—â–µ–π –æ—á–µ—Ä–µ–¥–∏ –∏ –∑–∞–ø–∞—Ä–∫–æ–≤–∞—Ç—å –ø–æ—Ç–æ–∫ –Ω–∞ –∫–æ–Ω–¥–≤–∞—Ä–µ.

### –ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ –Ω–∞–≥—Ä—É–∑–∫–∏

–î–ª—è –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏ –Ω–∞–≥—Ä—É–∑–∫–∏ –≤–æ—Ä–∫–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –¥–≤–∞ –º–µ—Ö–∞–Ω–∏–∑–º–∞:

- —Ä–∞–∑–¥–µ–ª—è–µ–º—É—é –æ—á–µ—Ä–µ–¥—å –∑–∞–¥–∞—á –∏ 
- –≤–æ—Ä–æ–≤—Å—Ç–≤–æ –∑–∞–¥–∞—á (_work-stealing_).

–í–æ—Ä–∫–µ—Ä—ã —Ä–∞–∑–¥–µ–ª—è—é—Ç –æ–±—â—É—é –æ—á–µ—Ä–µ–¥—å –∑–∞–¥–∞—á –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–π –µ–º–∫–æ—Å—Ç–∏ (–±—É–¥–µ–º –Ω–∞–∑—ã–≤–∞—Ç—å –µ–µ _–≥–ª–æ–±–∞–ª—å–Ω–æ–π_): –≤ –Ω–µ–µ –æ–Ω–∏ –≤—ã–≥—Ä—É–∂–∞—é—Ç –∏–∑–ª–∏—à–∫–∏ –∑–∞–¥–∞—á –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–π –æ—á–µ—Ä–µ–¥–∏, –∏–∑ –Ω–µ–µ –æ–Ω–∏ –∑–∞–±–∏—Ä–∞—é—Ç –Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏, –∫–æ–≥–¥–∞ –ª–æ–∫–∞–ª—å–Ω–∞—è –æ—á–µ—Ä–µ–¥—å –æ–ø—É—Å—Ç–æ—à–∞–µ—Ç—Å—è.

–ö–æ–≥–¥–∞ –∏ –ª–æ–∫–∞–ª—å–Ω–∞—è, –∏ –≥–ª–æ–±–∞–ª—å–Ω–∞—è –æ—á–µ—Ä–µ–¥–∏ –æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –ø—É—Å—Ç—ã, –≤–æ—Ä–∫–µ—Ä—ã –≤–æ—Ä—É—é—Ç –∑–∞–¥–∞—á–∏ –ø—Ä—è–º–æ –∏–∑ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –æ—á–µ—Ä–µ–¥–µ–π –¥—Ä—É–≥–∏—Ö –≤–æ—Ä–∫–µ—Ä–æ–≤ ([Work stealing](https://en.wikipedia.org/wiki/Work_stealing)).

### LIFO

–î–ª—è –±–æ–ª–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–≥–æ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–º—É–Ω–∏—Ü–∏—Ä—É—é—â–∏—Ö –∑–∞–¥–∞—á –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç LIFO-–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:

–ö –ª–æ–∫–∞–ª—å–Ω–æ–π –æ—á–µ—Ä–µ–¥–∏ –Ω–∞ –∫–∞–∂–¥–æ–º –≤–æ—Ä–∫–µ—Ä–µ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è LIFO-—Å–ª–æ—Ç, –∫–æ—Ç–æ—Ä—ã–π –∏–º–µ–µ—Ç –Ω–∞–∏–≤—ã—Å—à–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –æ—á–µ—Ä–µ–¥–Ω–æ–π –∑–∞–¥–∞—á–∏ –¥–ª—è –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è.

### –ê–ª–≥–æ—Ä–∏—Ç–º

#### –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏

- –ï—Å–ª–∏ –∑–∞–¥–∞—á–∞ –ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è –∏–∑ –≤–æ—Ä–∫–µ—Ä–∞ –ø—É–ª–∞, —Ç–æ –æ–Ω–∞ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ —Ö–≤–æ—Å—Ç –ª–æ–∫–∞–ª—å–Ω–æ–π –æ—á–µ—Ä–µ–¥–∏ –ª–∏–±–æ –≤ LIFO-—Å–ª–æ—Ç, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —è–≤–Ω–æ –ø–æ–ø—Ä–æ—Å–∏–ª –æ –ø–æ—Å–ª–µ–¥–Ω–µ–º —Å –ø–æ–º–æ—â—å—é —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–π –ø–æ–¥—Å–∫–∞–∑–∫–∏.

- –ï—Å–ª–∏ –∑–∞–¥–∞—á–∞ –ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è –∏–∑ –≤–Ω–µ—à–Ω–µ–≥–æ (–ø–æ –æ—Ç–Ω–æ—à–µ–Ω–∏—é –∫ –ø—É–ª—É) –ø–æ—Ç–æ–∫–∞, —Ç–æ –æ–Ω–∞ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ —Ö–≤–æ—Å—Ç –æ–±—â–µ–π –æ—á–µ—Ä–µ–¥–∏.

#### –í—ã–±–æ—Ä –∑–∞–¥–∞—á–∏ –¥–ª—è –∑–∞–ø—É—Å–∫–∞

–í–æ—Ä–∫–µ—Ä –ø–µ—Ä–µ–±–∏—Ä–∞–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∑–∞–¥–∞—á (–≤ –ø–æ—Ä—è–¥–∫–µ —É–±—ã–≤–∞–Ω–∏—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞):

1) LIFO-—Å–ª–æ—Ç
2) –õ–æ–∫–∞–ª—å–Ω–∞—è –æ—á–µ—Ä–µ–¥—å
3) –ì–ª–æ–±–∞–ª—å–Ω–∞—è –æ—á–µ—Ä–µ–¥—å
4) Work stealing 

#### Semi-Fairness

–ö–∞–∂–¥–∞—è –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤ –ø—É–ª –ø–æ—Ç–æ–∫–æ–≤ –∑–∞–¥–∞—á–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∏—Å–ø–æ–ª–Ω–µ–Ω–∞.

–û–¥–Ω–∞–∫–æ –µ—Å–ª–∏ –∑–∞–¥–∞—á—É –≤—ã–±–∏—Ä–∞—Ç—å –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –ø–ª–∞–Ω–æ–º –≤—ã—à–µ, —Ç–æ –≤–æ–∑–º–æ–∂–Ω—ã —Å—Ü–µ–Ω–∞—Ä–∏–∏, –∫–æ–≥–¥–∞ –∑–∞–¥–∞—á–∞ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–µ, –Ω–æ –≤–æ—Ä–∫–µ—Ä—ã –µ–µ –Ω–µ –∑–∞–ø—É—Å–∫–∞—é—Ç:

1) –ó–∞–¥–∞—á–∞ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –æ—á–µ—Ä–µ–¥–∏, –ø—Ä–∏ —ç—Ç–æ–º –≤ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –æ—á–µ—Ä–µ–¥—è—Ö –≤–æ—Ä–∫–µ—Ä–æ–≤ –≤—Å–µ–≥–¥–∞ –æ—Å—Ç–∞—é—Ç—Å—è –∑–∞–¥–∞—á–∏, —Ç–∞–∫ —á—Ç–æ –≤–æ—Ä–∫–µ—Ä—ã –Ω–µ –ø—Ä–æ–≤–µ—Ä—è—é—Ç –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ—á–µ—Ä–µ–¥—å.

2) –î–≤–∞ —Ñ–∞–π–±–µ—Ä–∞ –æ–±–º–µ–Ω–∏–≤–∞—é—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ —á–µ—Ä–µ–∑ –∫–∞–Ω–∞–ª—ã, –ø–æ —Ü–∏–∫–ª—É –∑–∞–ø—É—Å–∫–∞—è –¥—Ä—É–≥ –¥—Ä—É–≥–∞ —á–µ—Ä–µ–∑ LIFO-—Å–ª–æ—Ç, —Ç–∞–∫ —á—Ç–æ –≤–æ—Ä–∫–µ—Ä –≤–æ–æ–±—â–µ –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ª–æ–∫–∞–ª—å–Ω—É—é –æ—á–µ—Ä–µ–¥—å.

–î–ª—è —Ä–µ—à–µ–Ω–∏—è –ø–µ—Ä–≤–æ–π –ø—Ä–æ–±–ª–µ–º—ã –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –æ–ø—Ä–∞—à–∏–≤–∞–π—Ç–µ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ—á–µ—Ä–µ–¥—å –∑–∞–¥–∞—á _–¥–æ_ –ø—Ä–æ–≤–µ—Ä–∫–∏ LIFO-—Å–ª–æ—Ç–∞ (–≤—Å–ø–æ–º–Ω–∏—Ç–µ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω—É—é –∫–æ–Ω—Å—Ç–∞–Ω—Ç—É –î–º–∏—Ç—Ä–∏—è –í—å—é–∫–æ–≤–∞ ‚Äì 61).

–î–ª—è —Ä–µ—à–µ–Ω–∏—è –≤—Ç–æ—Ä–æ–π –ø—Ä–æ–±–ª–µ–º—ã –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–π—Ç–µ —á–∏—Å–ª–æ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–ø—É—Å–∫–æ–≤ –∑–∞–¥–∞—á —á–µ—Ä–µ–∑ LIFO-—Å–ª–æ—Ç. –ú–æ–∂–Ω–æ –¥—É–º–∞—Ç—å –æ–± —ç—Ç–æ–º —Ç–∞–∫: –∑–∞–¥–∞—á–∞, –≤–∑—è—Ç–∞—è –∏–∑ LIFO-—Å–ª–æ—Ç–∞, –Ω–∞—Å–ª–µ–¥—É–µ—Ç –∫–≤–∞–Ω—Ç –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–µ–¥—à–µ—Å—Ç–≤—É—é—â–µ–π –∑–∞–¥–∞—á–∏.

#### –ü–∞—Ä–∫–æ–≤–∫–∞

–ü–æ—Ç–æ–∫-–≤–æ—Ä–∫–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ —Å–º–æ–≥ –Ω–∞–π—Ç–∏ –∑–∞–¥–∞—á–∏ –¥–ª—è –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è, –¥–æ–ª–∂–µ–Ω –ø–∞—Ä–∫–æ–≤–∞—Ç—å—Å—è –∏ –Ω–µ —Ç—Ä–∞—Ç–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–Ω–æ–µ –≤—Ä–µ–º—è.

–í–æ—Ä–∫–µ—Ä –ù–ï –¥–æ–ª–∂–µ–Ω –ø–∞—Ä–∫–æ–≤–∞—Ç—å—Å—è, –µ—Å–ª–∏ –≤ –æ—á–µ—Ä–µ–¥—è—Ö –ø—É–ª–∞ –æ—Å—Ç–∞—é—Ç—Å—è –Ω–µ–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏.

## –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

### –ò–Ω—Ç—Ä—É–∑–∏–≤–Ω–æ—Å—Ç—å

–î–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ –ø–æ—Ç—Ä–µ–±—É—é—Ç—Å—è _–∏–Ω—Ç—Ä—É–∑–∏–≤–Ω—ã–µ_ –∑–∞–¥–∞—á–∏.

–ü–æ–¥ –∏–Ω—Ç—Ä—É–∑–∏–≤–Ω–æ–π –º—ã –ø–æ–Ω–∏–º–∞–µ–º –∑–∞–¥–∞—á—É, –∫–æ—Ç–æ—Ä–∞—è
- —Å–∞–º–∞ —É–ø—Ä–∞–≤–ª—è–µ—Ç –≤—Ä–µ–º–µ–Ω–µ–º —Å–≤–æ–µ–π –∂–∏–∑–Ω–∏ –∏
- —É–º–µ–µ—Ç –≤—Å—Ç—Ä–∞–∏–≤–∞—Ç—å—Å—è –≤–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞.

–ò–Ω—Ç—Ä—É–∑–∏–≤–Ω–∞—è –∑–∞–¥–∞—á–∞ —Ä–µ–∞–ª–∏–∑—É–µ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å [`ITask`](exe/executors/task.hpp) —Å –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–º –º–µ—Ç–æ–¥–æ–º `Run` ‚Äì –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–¥–∞—á—É.

–ò–Ω—Ç—Ä—É–∑–∏–≤–Ω–∞—è –∑–∞–¥–∞—á–∞ –Ω–∞—Å–ª–µ–¥—É–µ—Ç—Å—è –æ—Ç `TaskBase`, –≤ –∫–æ—Ç–æ—Ä—ã–π –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –ø–æ–º–µ—â–∞–µ—Ç—Å—è —É–∫–∞–∑–∞—Ç–µ–ª—å
–¥–ª—è —Å–≤—è–∑—ã–≤–∞–Ω–∏—è –∑–∞–¥–∞—á –≤ –æ—á–µ—Ä–µ–¥–∏.

### –õ–æ–∫–∞–ª—å–Ω–∞—è –æ—á–µ—Ä–µ–¥—å

[`WorkStealingQueue`](exe/executors/tp/fast/queues/work_stealing_queue.hpp)

–õ–æ–∫–∞–ª—å–Ω–∞—è –æ—á–µ—Ä–µ–¥—å –∑–∞–¥–∞—á –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π –ª–æ–∫-—Ñ—Ä–∏ —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏–π –±—É—Ñ–µ—Ä —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞.

- –ú–µ—Ç–æ–¥—ã `TryPush` –∏ `TryPop` –≤—ã–∑—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ—é—â–∏–π –æ—á–µ—Ä–µ–¥—å—é –≤–æ—Ä–∫–µ—Ä.
- –ú–µ—Ç–æ–¥ `Grab` –≤—ã–∑—ã–≤–∞—é—Ç
  - –¥—Ä—É–≥–∏–µ –≤–æ—Ä–∫–µ—Ä—ã –ø—Ä–∏ –≤–æ—Ä–æ–≤—Å—Ç–≤–µ –∑–∞–¥–∞—á,
  - –≤–ª–∞–¥–µ—é—â–∏–π –æ—á–µ—Ä–µ–¥—å—é –≤–æ—Ä–∫–µ—Ä –¥–ª—è –≤—ã–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á –≤ –æ–±—â—É—é –æ—á–µ—Ä–µ–¥—å –ø—Ä–∏ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–∏ –ª–æ–∫–∞–ª—å–Ω–æ–π.

### –ì–ª–æ–±–∞–ª—å–Ω–∞—è –æ—á–µ—Ä–µ–¥—å

[`GlobalQueue`](exe/executors/tp/fast/queues/global_queue.hpp)

–ì–ª–æ–±–∞–ª—å–Ω–∞—è –æ—á–µ—Ä–µ–¥—å
- –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∑–∞–¥–∞—á–∏ –æ—Ç "–≤–Ω–µ—à–Ω–∏—Ö" `Submit`-–æ–≤,
- –ø–æ–º–æ–≥–∞–µ—Ç –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á–∏ –º–µ–∂–¥—É –≤–æ—Ä–∫–µ—Ä–∞–º–∏.

#### Offload

–ï—Å–ª–∏ –ª–æ–∫–∞–ª—å–Ω–∞—è –æ—á–µ—Ä–µ–¥—å –≤–æ—Ä–∫–µ—Ä–∞ –ø–µ—Ä–µ–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏, —Ç–æ
–ø–æ–ª–æ–≤–∏–Ω–∞ –∑–∞–¥–∞—á –∏–∑ –Ω–µ–µ –≤—ã–≥—Ä—É–∂–∞–µ—Ç—Å—è –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ—á–µ—Ä–µ–¥—å —Å –ø–æ–º–æ—â—å—é –º–µ—Ç–æ–¥–∞ `OffloadTasksToGlobalQueue`.

–ú–∏–Ω–∏–º–∏–∑–∏—Ä—É–π—Ç–µ —Ä–∞–±–æ—Ç—É –≤ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π —Å–µ–∫—Ü–∏–∏ –ø—Ä–∏ –≤—ã–≥—Ä—É–∑–∫–µ –∑–∞–¥–∞—á –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ—á–µ—Ä–µ–¥—å: –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤ `GlobalQueue` [–∏–Ω—Ç—Ä—É–∑–∏–≤–Ω—ã–π —Å–ø–∏—Å–æ–∫](https://gitlab.com/Lipovsky/wheels/-/blob/master/wheels/intrusive/forward_list.hpp),
–¥–æ–±–∞–≤–ª—è–π—Ç–µ –≤ –Ω–µ–≥–æ –ø–∞—á–∫—É –∑–∞–¥–∞—á –∑–∞ O(1) —Å –ø–æ–º–æ—â—å—é –º–µ—Ç–æ–¥–∞ `Append`.

#### Grab

–ï—Å–ª–∏ –ª–æ–∫–∞–ª—å–Ω–∞—è –æ—á–µ—Ä–µ–¥—å –≤–æ—Ä–∫–µ—Ä–∞ –æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø—É—Å—Ç–∞, –≤–æ—Ä–∫–µ—Ä –ø—ã—Ç–∞–µ—Ç—Å—è –∑–∞–±—Ä–∞—Ç—å –ø–∞—á–∫—É –∑–∞–¥–∞—á –∏–∑ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –æ—á–µ—Ä–µ–¥–∏ —Å –ø–æ–º–æ—â—å—é –º–µ—Ç–æ–¥–∞ `TryGrabTasksFromGlobalQueue`.

–ü–æ–¥—É–º–∞–π—Ç–µ –∫–∞–∫ –≤—ã–±—Ä–∞—Ç—å —Ä–∞–∑–º–µ—Ä –ø–∞—á–∫–∏ —á—Ç–æ–±—ã –∞–∫–∫—É—Ä–∞—Ç–Ω–µ–µ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–≥—Ä—É–∑–∫—É –º–µ–∂–¥—É –≤–æ—Ä–∫–µ—Ä–∞–º–∏.

### Work stealing

–ï—Å–ª–∏ –ª–æ–∫–∞–ª—å–Ω–∞—è –∏ –≥–ª–æ–±–∞–ª—å–Ω–∞—è –æ—á–µ—Ä–µ–¥—å –ø—É—Å—Ç—ã, –≤–æ—Ä–∫–µ—Ä –≤–æ—Ä—É–µ—Ç –Ω–∞–ø—Ä—è–º—É—é –∏–∑ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –æ—á–µ—Ä–µ–¥–µ–π –¥—Ä—É–≥–∏—Ö –≤–æ—Ä–∫–µ—Ä–æ–≤.

–û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–π—Ç–µ —á–∏—Å–ª–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –≤–æ—Ä—É—é—â–∏—Ö –≤–æ—Ä–∫–µ—Ä–æ–≤: –µ—Å–ª–∏ –≤ –ø—É–ª–µ –æ—Å—Ç–∞–µ—Ç—Å—è –º–∞–ª–æ —Ä–∞–±–æ—Ç—ã, —Ç–æ –≤–æ—Ä–∫–µ—Ä—ã –Ω–µ –¥–æ–ª–∂–Ω—ã –ø—Ä–∞–∑–¥–Ω–æ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞—Ç—å –∑–∞–¥–∞—á–∏ –¥—Ä—É–≥ —É –¥—Ä—É–≥–∞. –ò–∑—É—á–∏—Ç–µ –∫–∞–∫ —É—Å—Ç—Ä–æ–µ–Ω–æ —ç—Ç–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≤ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞—Ö Go –∏ Tokio.

–†–∞–Ω–¥–æ–º–∏–∑–∏—Ä—É–π—Ç–µ –ø–æ—Ä—è–¥–æ–∫ –æ–±—Ö–æ–¥–∞ "–∂–µ—Ä—Ç–≤" —Å –ø–æ–º–æ—â—å—é [`mt19937_64`](https://en.cppreference.com/w/cpp/numeric/random).

–î–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –≤–∏—Ö—Ä—è –ú–µ—Ä—Å–µ–Ω–Ω–∞ –≤ –≤–æ—Ä–∫–µ—Ä–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ [`random_device` –∏–∑ `twist`](https://gitlab.com/Lipovsky/twist/-/blob/master/twist/ed/stdlike/random.hpp): –æ–Ω –æ–±–µ—Å–ø–µ—á–∏—Ç –¥–µ—Ç–µ—Ä–º–∏–Ω–∏–∑–º –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Ç–µ—Å—Ç–æ–≤ –ø–æ–¥ —Ñ–∞–π–±–µ—Ä–∞–º–∏.

### LIFO-—Å–ª–æ—Ç –∏ —á–µ—Å—Ç–Ω–æ—Å—Ç—å

–ü–æ–¥–¥–µ—Ä–∂–∏—Ç–µ LIFO-—Å–ª–æ—Ç –ø—Ä–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏: –∑–∞–¥–∞—á–∞, –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø—Ä—è–º–æ –∏–∑ –ø—É–ª–∞ –ø–æ—Ç–æ–∫–æ–≤, –ø–æ–ø–∞–¥–∞–µ—Ç –≤ —ç—Ç–æ—Ç —Å–ª–æ—Ç –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —É–∂–µ –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏ –≤–æ—Ä–∫–µ—Ä–∞.

–ï—Å–ª–∏ –ø—Ä–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ –∑–∞–¥–∞—á–∏ –≤ LIFO-—Å–ª–æ—Ç –æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è, —á—Ç–æ —Ç–æ—Ç —É–∂–µ –∑–∞–Ω—è—Ç –¥—Ä—É–≥–æ–π –∑–∞–¥–∞—á–µ–π, —Ç–æ –ø–æ—Å–ª–µ–¥–Ω—è—è –≤—ã—Ç–µ—Å–Ω—è–µ—Ç—Å—è –≤ —Ö–≤–æ—Å—Ç –ª–æ–∫–∞–ª—å–Ω–æ–π –æ—á–µ—Ä–µ–¥–∏.

–û–≥—Ä–∞–Ω–∏—á—å—Ç–µ —á–∏—Å–ª–æ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö –∏—Ç–µ—Ä–∞—Ü–∏–π –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ LIFO-—Å–ª–æ—Ç –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è —á–µ—Å—Ç–Ω–æ—Å—Ç–∏.

#### –ü–æ–¥—Å–∫–∞–∑–∫–∏

–î–∞–π—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ñ–∞–π–±–µ—Ä–∞–º) –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —É–ø—Ä–∞–≤–ª—è—Ç—å –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º: –ø–æ–¥–¥–µ—Ä–∂–∏—Ç–µ –≤ –º–µ—Ç–æ–¥–µ `Submit` (–∏ –≤ `FiberHandle::Schedule`) –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä [`SchedulerHint`](exe/executors/hint.hpp) ‚Äì –ø–æ–¥—Å–∫–∞–∑–∫—É –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫—É.

–ü–æ–¥—Å–∫–∞–∑–∫–∏ –Ω–µ–¥–∏—Ä–µ–∫—Ç–∏–≤–Ω—ã: –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –∫–æ–¥–∞, –∫–æ—Ç–æ—Ä—ã–π –¥–∞–µ—Ç –ø–æ–¥—Å–∫–∞–∑–∫—É –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫—É, –Ω–µ –¥–æ–ª–∂–Ω–∞ –∑–∞–≤–∏—Å–µ—Ç—å –æ—Ç —Ç–æ–≥–æ, –±—ã–ª–∞ –ª–∏ —ç—Ç–∞ –ø–æ–¥—Å–∫–∞–∑–∫–∞ —É—á—Ç–µ–Ω–∞ –ø—Ä–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏.

#### Default

–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é `fast::ThreadPool` –¥–æ–ª–∂–µ–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å FIFO-–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ. 

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –∫–æ—Ç–æ—Ä—ã–π —Å—Ç–∞–≤–∏—Ç –≤ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –¥–æ–ª–∂–µ–Ω –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –Ω–∞ LIFO-–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —è–≤–Ω–æ, —É–∫–∞–∑—ã–≤–∞—è `SchedulerHint::Next`.

### `Yield`

–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∑–∞–¥–∞—á–∏, –∫–æ—Ç–æ—Ä—ã–µ –ø–ª–∞–Ω–∏—Ä—É—é—Ç—Å—è –∏–∑ —Å–∞–º–æ–≥–æ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞, –æ–±—Å–ª—É–∂–∏–≤–∞—é—Ç—Å—è —Ç–µ–∫—É—â–∏–º –ø–æ—Ç–æ–∫–æ–º-–≤–æ—Ä–∫–µ—Ä–æ–º: –ø–æ–ø–∞–¥–∞—é—Ç –ª–∏–±–æ –≤ –µ–≥–æ –ª–æ–∫–∞–ª—å–Ω—É—é –æ—á–µ—Ä–µ–¥—å, –ª–∏–±–æ –≤ LIFO-—Å–ª–æ—Ç.

–î–ª—è —Ñ—É–Ω–∫—Ü–∏–∏ `Yield` —Ç–∞–∫–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç: —Ñ–∞–π–±–µ—Ä —Ö–æ—á–µ—Ç —É—Å—Ç—É–ø–∏—Ç—å –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –≤—Å–µ–º —Ñ–∞–π–±–µ—Ä–∞–º, –∞ –Ω–µ —Ç–æ–ª—å–∫–æ —Ñ–∞–π–±–µ—Ä–∞–º –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–π –æ—á–µ—Ä–µ–¥–∏.

–°–¥–µ–ª–∞–π—Ç–µ –¥–ª—è `Yield` –æ—Ç–¥–µ–ª—å–Ω—É—é –ø–æ–¥—Å–∫–∞–∑–∫—É –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–π—Ç–µ —Ñ–∞–π–±–µ—Ä –≤ –∫–æ–Ω–µ—Ü –≥–ª–æ–±–∞–ª—å–Ω–æ–π –æ—á–µ—Ä–µ–¥–∏.

### –ö–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è / –ø–∞—Ä–∫–æ–≤–∫–∞ –≤–æ—Ä–∫–µ—Ä–æ–≤

–í–æ—Ä–∫–µ—Ä—ã —Å—Ç–∞—Ä–∞—é—Ç—Å—è —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ, –Ω–æ –∏–Ω–æ–≥–¥–∞ –∏–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è, –Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è –ø–∞—Ä–∫–æ–≤–∫–∏.

–ò–∑—É—á–∏—Ç–µ [–º–µ—Ö–∞–Ω–∏–∑–º –ø–∞—Ä–∫–æ–≤–∫–∏ –ø–æ—Ç–æ–∫–æ–≤](https://github.com/golang/go/blob/d2552037426fe5a190c74172562d897d921fe311/src/runtime/proc.go#L31) –≤ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–µ `Go`.

–ò–∑—É—á–∏—Ç–µ [—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é](https://github.com/tokio-rs/tokio/blob/master/tokio/src/runtime/scheduler/multi_thread/idle.rs) —ç—Ç–æ–≥–æ –º–µ—Ö–∞–Ω–∏–∑–º–∞ –≤ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–µ [Tokio](https://github.com/tokio-rs/tokio).

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∞–Ω–∞–ª–æ–≥–∏—á–Ω—É—é –¥–≤—É—Ö—Ñ–∞–∑–Ω—É—é –ø–∞—Ä–∫–æ–≤–∫—É, —Ä–µ–∞–ª–∏–∑—É–π—Ç–µ –µ–µ —á–µ—Ä–µ–∑ –∫–ª–∞—Å—Å [`Coordinator`](exe/executors/tp/fast/coordinator.hpp). 

–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—á–µ—Ä–µ–¥–µ–π –Ω–∞ –ø—É—Å—Ç–æ—Ç—É –ø–æ—Å–ª–µ –∞–Ω–æ–Ω—Å–∞ –ø–∞—Ä–∫–æ–≤–∫–∏ ‚Äì –º–µ—Ç–æ–¥ `TryPickTaskBeforePark`.

–ù–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ –¥–ª—è –ø–∞—Ä–∫–æ–≤–∫–∏ –≤–æ—Ä–∫–µ—Ä–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ—Ç–¥–µ–ª—å–Ω—ã–π –∞—Ç–æ–º–∏–∫ `wakeups`.

### `WaitIdle`

üö® –£ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ –≤ —ç—Ç–æ–π –∑–∞–¥–∞—á–µ –Ω–µ –±—É–¥–µ—Ç –º–µ—Ç–æ–¥–∞ `WaitIdle`!

–ù–∞–∏–≤–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —ç—Ç–æ–≥–æ –º–µ—Ç–æ–¥–∞ —á–µ—Ä–µ–∑ –ø–æ–¥—Å—á–µ—Ç –∑–∞–¥–∞—á –¥–æ–±–∞–≤–ª—è–µ—Ç —Ç–æ—á–∫—É –∫–æ–Ω—Ç–µ–Ω—à–µ–Ω–∞ –Ω–∞ –±—ã—Å—Ç—Ä–æ–º –ø—É—Ç–∏ `Submit`.

–í–º–µ—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `WaitIdle` –º—ã –ø–æ–ø—Ä–æ—Å–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—É–ª–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ–∂–∏–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á —Å–≤–æ–∏–º–∏ —Å–∏–ª–∞–º–∏ —Å –ø–æ–º–æ—â—å—é [`exe::threads::WaitGroup`](exe/threads/wait_group.hpp).

[–ë–æ–Ω—É—Å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å] –ü—Ä–∏–¥—É–º–∞–π—Ç–µ –∏ —Ä–µ–∞–ª–∏–∑—É–π—Ç–µ `WaitIdle`, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –±—É–¥–µ—Ç —Ç—Ä–µ–±–æ–≤–∞—Ç—å –Ω–∞ –±—ã—Å—Ç—Ä–æ–º –ø—É—Ç–∏ `Submit` –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–æ–≤ —Ä–∞–∑–¥–µ–ª—è–µ–º–æ–≥–æ –∞—Ç–æ–º–∏–∫–∞.

### `thread_local`

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ [`TWISTED_THREAD_LOCAL_PTR`](https://gitlab.com/Lipovsky/twist/-/blob/master/examples/local/main.cpp) —á—Ç–æ–±—ã –Ω–µ –ø–ª–∞—Ç–∏—Ç—å
–∑–∞ —ç–º—É–ª—è—Ü–∏—é —Ç—Ä–µ–¥-–ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —É–∫–∞–∑–∞—Ç–µ–ª—è –¥–ª—è —Ñ–∞–π–±–µ—Ä–æ–≤ –∏–∑ `twist`.

### –ê–ª–ª–æ–∫–∞—Ü–∏–∏

–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –Ω–µ –¥–æ–ª–∂–µ–Ω –∞–ª–ª–æ—Ü–∏—Ä–æ–≤–∞—Ç—å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫—É—é –ø–∞–º—è—Ç—å –ø—Ä–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ / –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–¥–∞—á:
- –õ–æ–∫–∞–ª—å–Ω–∞—è –æ—á–µ—Ä–µ–¥—å ‚Äì —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –±—É—Ñ–µ—Ä —É–∫–∞–∑–∞—Ç–µ–ª–µ–π –Ω–∞ –∑–∞–¥–∞—á–∏
- –ì–ª–æ–±–∞–ª—å–Ω–∞—è –æ—á–µ—Ä–µ–¥—å ‚Äì –∏–Ω—Ç—Ä—É–∑–∏–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∑–∞–¥–∞—á

### –õ–æ–∫-—Ñ—Ä–∏

[–ë–æ–Ω—É—Å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å]

–ò–∑–±–∞–≤—å—Ç–µ—Å—å –æ—Ç –≤–∑–∞–∏–º–Ω–æ–≥–æ –∏—Å–∫–ª—é—á–µ–Ω–∏—è –≤ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏, –¥–æ–±–µ–π—Ç–µ—Å—å –≥–∞—Ä–∞–Ω—Ç–∏–∏ –ª–æ–∫-—Ñ—Ä–∏.

–í—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–µ—à–µ–Ω–∏—è –∑–∞–¥–∞—á [`lockfree`](/tasks/lockfree).

–í—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `moodycamel::ConcurrentQueue`:

- https://github.com/cameron314/concurrentqueue
- [A Fast General Purpose Lock-Free Queue for C++](https://moodycamel.com/blog/2014/a-fast-general-purpose-lock-free-queue-for-c++.htm)
- [Detailed Design of a Lock-Free Queue](https://moodycamel.com/blog/2014/detailed-design-of-a-lock-free-queue.htm)

–ó–∞–≥–æ–ª–æ–≤–æ–∫: `<concurrentqueue.h>`

–í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –∏–∑—É—á–∏—Ç–µ —Å–≤–æ–π—Å—Ç–≤–∞ —ç—Ç–æ–π –æ—á–µ—Ä–µ–¥–∏ –ø–µ—Ä–µ–¥ –µ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º!

### –ú–µ—Ç—Ä–∏–∫–∏

–°–æ–±–∏—Ä–∞–π—Ç–µ [–º–µ—Ç—Ä–∏–∫–∏](exe/executors/tp/fast/metrics.hpp), –Ω–∞–ø—Ä–∏–º–µ—Ä:

- –°–∫–æ–ª—å–∫–æ –∑–∞–¥–∞—á –±—ã–ª–æ –∑–∞–ø—É—â–µ–Ω–æ —á–µ—Ä–µ–∑ LIFO-—Å–ª–æ—Ç / –ª–æ–∫–∞–ª—å–Ω—É—é –æ—á–µ—Ä–µ–¥—å / –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ—á–µ—Ä–µ–¥—å
- –°–∫–æ–ª—å–∫–æ —Ä–∞–∑ –≤–æ—Ä–∫–µ—Ä—ã –≤–æ—Ä–æ–≤–∞–ª–∏ –∑–∞–¥–∞—á–∏, –≤—ã–≥—Ä—É–∂–∞–ª–∏ –∑–∞–¥–∞—á–∏ –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ—á–µ—Ä–µ–¥—å, –∑–∞–±–∏—Ä–∞–ª–∏ –∑–∞–¥–∞—á–∏ –∏–∑ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –æ—á–µ—Ä–µ–¥–∏ 
- –°–∫–æ–ª—å–∫–æ —Ä–∞–∑ –≤–æ—Ä–∫–µ—Ä—ã –ø–∞—Ä–∫–æ–≤–∞–ª–∏—Å—å –∏–∑-–∑–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –∑–∞–¥–∞—á
- –∏ —Ç.–ø.

–ú–µ—Ç—Ä–∏–∫–∏ –ø–æ–º–æ–≥—É—Ç –ø–æ–Ω—è—Ç—å –ø–æ–≤–µ–¥–µ–Ω–∏–µ –≤–∞—à–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –≤ —Ä–∞–∑–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏—è—Ö –Ω–∞–≥—Ä—É–∑–∫–∏.

–°–æ–±–∏—Ä–∞–π—Ç–µ –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤–æ—Ä–∫–µ—Ä–∞ –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ, –±–µ–∑ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏.

### –ö–æ–Ω—Ñ–∏–≥

–ü–æ–¥–¥–µ—Ä–∂–∏—Ç–µ –∫–æ–Ω—Ñ–∏–≥ –¥–ª—è —Å–≤–æ–±–æ–¥–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –≤–æ–∑–Ω–∏–∫–∞—é—Ç –≤ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏: —Ç–∞–∫ –±—É–¥–µ—Ç —É–¥–æ–±–Ω–µ–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç—å –≤–ª–∏—è–Ω–∏–µ —ç—Ç–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –Ω–∞ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø—É–ª–∞.

## –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ

–ü—Ä–æ—Ñ–∏–ª–∏—Ä—É–π—Ç–µ –≤–∞—à—É —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –Ω–∞ [`workloads`](workloads/main.cpp) —á—Ç–æ–±—ã –ø–æ–Ω—è—Ç—å, –Ω–∞ —á—Ç–æ –≤—ã —Ä–∞—Å—Ö–æ–¥—É–µ—Ç–µ –≤—Ä–µ–º—è –ø—Ä–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏.

[Flame Graphs](https://www.brendangregg.com/flamegraphs.html)

–í —Ä–µ–ª–∏–∑–Ω–æ–π —Å–±—Ä–æ–∫–µ –∫–æ–¥ –±—É–¥–µ—Ç —Å–æ–±–∏—Ä–∞—Ç—å—Å—è —Å —Ö–æ—Ä–æ—à–∏–º –∞–ª–ª–æ–∫–∞—Ç–æ—Ä–æ–º: https://github.com/microsoft/mimalloc 

## –ó–∞–¥–∞–Ω–∏–µ

### –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç–µ–ª—å–Ω—ã–µ —à–∞–≥–∏

0) –ü–µ—Ä–µ–Ω–µ—Å–∏—Ç–µ `WaitGroup` –∏–∑ –∑–∞–¥–∞—á–∏ [cond/wait_group](/tasks/cond/wait_group) –≤ [`exe/threads`](exe/threads/wait_group.hpp)
1) –†–µ–∞–ª–∏–∑—É–π—Ç–µ –∏–Ω—Ç—Ä—É–∑–∏–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏ –≤ [tasks/executors](/tasks/tasks/executors), –±–µ–∑ –Ω–∏—Ö —Ö–æ—Ä–æ—à–∏–π –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –Ω–∞–ø–∏—Å–∞—Ç—å –Ω–µ –ø–æ–ª—É—á–∏—Ç—Å—è.
2) –ü–µ—Ä–µ–Ω–µ—Å–∏—Ç–µ –ø—É–ª –ø–æ—Ç–æ–∫–æ–≤ –∏–∑ [tasks/executors](/tasks/tasks/executors), –æ–Ω –ø–æ—Å–ª—É–∂–∏—Ç baseline-–æ–º –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞.
3) –ü–µ—Ä–µ–Ω–µ—Å–∏—Ç–µ —Ñ–∞–π–±–µ—Ä—ã –∏–∑ [fibers/mutex](/tasks/fibers/mutex), –∞–¥–∞–ø—Ç–∏—Ä—É–π—Ç–µ –∏—Ö –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –≤ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–º —ç–∫–∑–µ–∫—É—Ç–æ—Ä–µ.
4) –ü—Ä–æ–π–¥–∏—Ç–µ —Ç–µ—Å—Ç—ã, —É—Å—Ç–∞–Ω–æ–≤–∏–≤ –≤ –∫–∞—á–µ—Å—Ç–≤–µ [–¥–µ—Ñ–æ–ª—Ç–Ω–æ–≥–æ –ø—É–ª–∞](exe/executors/thread_pool.hpp) –ø—É–ª [`tp::compute::ThreadPool`](exe/executors/tp/compute/thread_pool.hpp).

### –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫

4) –†–µ–∞–ª–∏–∑—É–π—Ç–µ —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ —Å –ª–æ–∫–∞–ª—å–Ω—ã–º–∏ –æ—á–µ—Ä–µ–¥—è–º–∏ –∏ –æ–±—â–µ–π –æ—á–µ—Ä–µ–¥—å—é –¥–ª—è –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏ –Ω–∞–≥—Ä—É–∑–∫–∏.
5) –†–µ–∞–ª–∏–∑—É–π—Ç–µ work stealing.
6) –ü–æ–¥–¥–µ—Ä–∂–∏—Ç–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –¥–ª—è —ç–∫–∑–µ–∫—É—Ç–æ—Ä–æ–≤ –∏ LIFO-–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–π —Å–ª–æ—Ç.
7) [–ë–æ–Ω—É—Å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å] –†–µ–∞–ª–∏–∑—É–π—Ç–µ –ø–∞—Ä–∫–æ–≤–∫—É –ø–æ—Ç–æ–∫–æ–≤ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ —Å –ø–æ–º–æ—â—å—é –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä–∞ (—Ç–µ—Å—Ç—ã ‚Äì [pipelines/thread_pool/parking.json](pipelines/thread_pool/parking.json) –∏ [pipelines/thread_pool/balancing.json](pipelines/thread_pool/balancing.json))
8) [–ë–æ–Ω—É—Å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å] –ü–æ–¥–¥–µ—Ä–∂–∏—Ç–µ `WaitIdle` –±–µ–∑ –æ–≤–µ—Ä—Ö–µ–¥–∞ –Ω–∞ –±—ã—Å—Ç—Ä–æ–º –ø—É—Ç–∏ `Submit` (—Ç–µ—Å—Ç—ã ‚Äì [pipelines/thread_pool/wait_idle.json](pipelines/thread_pool/wait_idle.json)).
9) [–ë–æ–Ω—É—Å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å] –ò—Å–∫–ª—é—á–∏—Ç–µ –≤–∑–∞–∏–º–Ω–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –∏–∑ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏, –¥–æ–±–µ–π—Ç–µ—Å—å –≥–∞—Ä–∞–Ω—Ç–∏–∏ –ª–æ–∫-—Ñ—Ä–∏

## –¢–µ—Å—Ç—ã

–¢–µ—Å—Ç—ã –ø—Ä–æ–≤–µ—Ä—è—é—Ç –Ω–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –ø—É–ª–∞ –ø–æ—Ç–æ–∫–æ–≤, –∞ `executors::ThreadPool`, –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π –≤ [exe/executors/thread_pool.hpp](exe/executors/thread_pool.hpp).

–í—ã –º–æ–∂–µ—Ç–µ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å —ç—Ç–æ—Ç alias –º–µ–∂–¥—É —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è–º–∏ –≤–æ –≤—Ä–µ–º—è –æ—Ç–ª–∞–¥–∫–∏.

## References

### Work Stealing

- [Scheduling Multithreaded Computations by Work Stealing](http://supertech.csail.mit.edu/papers/steal.pdf)
- https://en.wikipedia.org/wiki/Work_stealing

### –î–∏–∑–∞–π–Ω

- [Scalable Go Scheduler Design Doc](https://golang.org/s/go11sched)
- [Go scheduler: Implementing language with lightweight concurrency](https://www.youtube.com/watch?v=-K11rY57K7k)
- [Making the Tokio scheduler 10x faster](https://tokio.rs/blog/2019-10-scheduler)

### –†–µ–∞–ª–∏–∑–∞—Ü–∏–∏

- [Golang](https://github.com/golang/go/blob/master/src/runtime/proc.go)
- [Tokio (Rust)](https://github.com/tokio-rs/tokio/tree/master/tokio/src/runtime/scheduler/multi_thread)
- [Kotlin](https://github.com/Kotlin/kotlinx.coroutines/blob/master/kotlinx-coroutines-core/jvm/src/scheduling/CoroutineScheduler.kt)
- [Cats Effect (Scala)](https://github.com/typelevel/cats-effect/blob/series/3.x/core/jvm/src/main/scala/cats/effect/unsafe/WorkStealingThreadPool.scala)
